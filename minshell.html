<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raylib Memory - Hard Mode</title>
    <style>
        body { 
            margin: 0; padding: 0; background-color: #111; color: #fff;
            font-family: sans-serif; display: flex; flex-direction: column;
            align-items: center; justify-content: center; height: 100vh;
            overflow: hidden;
        }

        /* --- Canvas & Spinner --- */
        #canvas {
            border-radius: 4px;
            box-shadow: 0 0 30px rgba(0,0,0,0.6);
            image-rendering: pixelated;
            max-width: 100%; max-height: 100%;
        }
        .spinner {
            height: 30px; width: 30px; margin: 0px auto;
            animation: rotation 0.6s linear infinite;
            border-left: 6px solid rgba(0, 174, 239, 0.15);
            border-right: 6px solid rgba(0, 174, 239, 0.15);
            border-bottom: 6px solid rgba(0, 174, 239, 0.15);
            border-top: 6px solid rgba(0, 174, 239, 0.8);
            border-radius: 100%;
            position: absolute; top: 50%; left: 50%;
            margin-top: -15px; margin-left: -15px; z-index: 999;
        }
        @keyframes rotation { from {transform: rotate(0deg);} to {transform: rotate(359deg);} }

        /* --- Leaderboard HUD --- */
        #leaderboard {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0, 0, 0, 0.85); padding: 15px;
            border-radius: 8px; border: 1px solid #00aeef;
            width: 220px; box-shadow: 0 0 10px rgba(0,0,0,0.5);
            font-family: monospace; z-index: 10;
        }
        #leaderboard h3 { margin: 0 0 10px 0; color: #00aeef; text-align: center; font-family: sans-serif; }
        #score-list { list-style: none; padding: 0; margin: 0; }
        #score-list li { 
            padding: 6px; border-bottom: 1px solid #444; 
            display: flex; justify-content: space-between;
            color: #ccc; font-size: 14px;
        }
        #score-list li:last-child { border-bottom: none; }
        .score-val { color: #ffd700; font-weight: bold; }
        .score-label { font-size: 10px; color: #666; vertical-align: middle; margin-left: 4px; }

        /* --- Custom Input Modal --- */
        #input-modal {
            display: none; /* Hidden by default */
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000;
            align-items: center; justify-content: center;
            flex-direction: column;
        }
        .modal-content {
            background: #222; padding: 30px; border-radius: 8px;
            border: 2px solid #444; text-align: center; width: 300px;
        }
        .modal-content h2 { margin-top: 0; color: #ffd700; }
        
        #player-name-input {
            width: 100%; padding: 10px; margin-top: 15px;
            font-size: 18px; text-align: center;
            border: 2px solid #444; border-radius: 4px;
            background: #111; color: white; outline: none;
            transition: border-color 0.2s;
        }

        /* Dynamic Input Colors */
        #player-name-input.match { border-color: #2ecc71; /* Green */ }
        #player-name-input.new { border-color: #e74c3c; /* Red */ }

        #match-status {
            display: block; height: 20px; margin-top: 5px;
            font-size: 12px; color: #888;
        }

        .btn-submit {
            background: #00aeef; color: white; border: none;
            padding: 10px 20px; font-size: 16px; border-radius: 4px;
            cursor: pointer; margin-top: 15px; width: 100%;
        }
        .btn-submit:hover { background: #0095cc; }
    </style>
  </head>
  <body>
    <div class="spinner" id='spinner'></div>
    
    <div id="leaderboard">
        <h3>Top Scores</h3>
        <ul id="score-list">
            <li style="justify-content:center; color:#888;">Loading...</li>
        </ul>
    </div>

    <div id="input-modal">
        <div class="modal-content">
            <h2>You Won!</h2>
            <div style="font-size: 40px; color: #00aeef; font-weight:bold;" id="modal-score">0</div>
            <p>Score</p>
            
            <input type="text" id="player-name-input" placeholder="Enter Name" maxlength="10" autocomplete="off">
            <span id="match-status"></span>
            
            <button class="btn-submit" onclick="submitScore()">Submit Score</button>
        </div>
    </div>

    <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" tabindex=-1></canvas>
    
    <script type='text/javascript'>
      var Module = {
        print: (function() { return function(text) { console.log(text); }; })(),
        canvas: document.getElementById('canvas'),
        setStatus: function(text) { if (!text) return; console.log("Status: " + text); },
        onRuntimeInitialized: function() {
            document.getElementById('spinner').style.display = 'none';
            document.getElementById('canvas').focus();
        }
      };

      // --- CONFIGURATION ---
      const PRIVATE_KEY = "FmD-OFRIfUiqAQRcOJfgIwXF4CTJUP2kyktm0h6ad4eQ"; 
      const PUBLIC_KEY  = "692222898f40bb186436a661";  
      const BASE_URL = "https://www.dreamlo.com/lb/";

      // Cache for existing players: { "name": score }
      let playersCache = {};
      let currentPendingScore = 0;

      // 1. Fetch Scores and Build Cache
      function renderScores() {
          const list = document.getElementById('score-list');
          
          fetch(`${BASE_URL}${PUBLIC_KEY}/json-asc`)
              .then(response => response.json())
              .then(data => {
                  // Reset Cache
                  playersCache = {};
                  
                  list.innerHTML = '';
                  if (!data.dreamlo.leaderboard) {
                      list.innerHTML = '<li style="color:#888;">No scores yet!</li>';
                      return;
                  }

                  let entries = data.dreamlo.leaderboard.entry;
                  if (!Array.isArray(entries)) { entries = [entries]; }

                  // Populate Cache for Live Search
                  entries.forEach(e => {
                      // Normalize name for matching
                      playersCache[e.name.toLowerCase()] = parseInt(e.score);
                  });

                  // Display Top 20
                  const topScores = entries.slice(0, 20);
                  topScores.forEach((entry, index) => {
                      const li = document.createElement('li');
                      li.innerHTML = `
                        <span>#${index + 1} ${entry.name.substring(0, 10)}</span> 
                        <div>
                            <span class="score-val">${entry.score}</span>
                            <span class="score-label">pts</span>
                        </div>
                      `;
                      list.appendChild(li);
                  });
              })
              .catch(err => {
                  console.error("Error:", err);
                  list.innerHTML = '<li style="color:red;">Offline</li>';
              });
      }

      // 2. Open Modal (Called from C++)
      window.updateLeaderboard = function(score) {
          currentPendingScore = score;
          const modal = document.getElementById('input-modal');
          const input = document.getElementById('player-name-input');
          const scoreDisplay = document.getElementById('modal-score');
          
          // Populate Score
          scoreDisplay.innerText = score;
          
          // Pre-fill name from Local Storage
          const cachedName = localStorage.getItem('memory_game_name');
          if (cachedName) {
              input.value = cachedName;
              validateInput(cachedName); // Run validation check immediately
          } else {
              input.value = "";
              validateInput("");
          }

          // Show Modal
          modal.style.display = 'flex';
          input.focus();
      };

      // 3. Live Input Validation
      const nameInput = document.getElementById('player-name-input');
      const statusSpan = document.getElementById('match-status');

      // Stop key events from bubbling up to Raylib/Emscripten
      // This prevents the game from intercepting Backspace, Arrow keys, or 'P' (Pause)
      ['keydown', 'keyup', 'keypress'].forEach(eventType => {
          nameInput.addEventListener(eventType, (e) => {
              e.stopPropagation();
          });
      });

      function validateInput(val) {
          const cleanVal = val.trim().toLowerCase();
          
          if (cleanVal.length === 0) {
              nameInput.className = ""; // Neutral
              statusSpan.innerText = "";
              return;
          }

          if (playersCache.hasOwnProperty(cleanVal)) {
              // MATCH FOUND
              nameInput.className = "match";
              statusSpan.style.color = "#2ecc71";
              
              const oldScore = playersCache[cleanVal];
              if (currentPendingScore < oldScore) {
                  statusSpan.innerText = `Existing Found. New Personal Best! (${oldScore} â†’ ${currentPendingScore})`;
              } else {
                  statusSpan.innerText = `Existing Found. Best remains: ${oldScore}`;
              }
          } else {
              // NO MATCH (New)
              nameInput.className = "new";
              statusSpan.style.color = "#e74c3c";
              statusSpan.innerText = "New Player Profile";
          }
      }

      nameInput.addEventListener('keyup', (e) => {
          validateInput(e.target.value);
          if (e.key === "Enter") submitScore();
      });

      // 4. Submit Logic
      window.submitScore = function() {
          let rawName = nameInput.value;
          if (!rawName) return;

          // Clean name
          let cleanName = rawName.replace(/[^a-zA-Z0-9]/g, "").substring(0, 10);
          if (cleanName.length === 0) cleanName = "Guest";

          // Save to LocalStorage for next time
          localStorage.setItem('memory_game_name', cleanName);

          // Logic: Update only if better
          const lowerName = cleanName.toLowerCase();
          let shouldUpdate = true;

          if (playersCache.hasOwnProperty(lowerName)) {
              const oldScore = playersCache[lowerName];
              // In this game, Lower is Better.
              // If new score is >= old score, do not update.
              if (currentPendingScore >= oldScore) {
                  shouldUpdate = false;
                  console.log("Score not improved. Skipping update.");
              }
          }

          const modal = document.getElementById('input-modal');
          modal.style.display = 'none';
          document.getElementById('canvas').focus();

          if (shouldUpdate) {
              const deleteUrl = `${BASE_URL}${PRIVATE_KEY}/delete/${cleanName}`;
              const addUrl = `${BASE_URL}${PRIVATE_KEY}/add/${cleanName}/${currentPendingScore}/0`;
              
              // 1. Delete the old score (if it exists)
              fetch(deleteUrl)
                  .then(response => {
                      if (!response.ok) {
                          console.warn("Delete might have failed or name didn't exist, proceeding to add.");
                      }
                      // 2. Add the new (better) score
                      return fetch(addUrl);
                  })
                  .then(() => { 
                      console.log("Score deleted and added successfully.");
                      renderScores(); 
                  })
                  .catch(err => console.error("Error updating score sequence:", err));

          } else {
              // Even if we don't update the DB, we should refresh the UI
              // in case other players have played in the meantime.
              renderScores(); 
          }
      };

      document.addEventListener('keydown', function(event) {
        // Check if the key pressed is Backspace (keyCode 8 or key 'Backspace')
        if (event.key === 'Backspace' || event.keyCode === 8) {
            // Check if the currently focused element is an INPUT, TEXTAREA, or is editable
            const target = event.target;
            const tagName = target.tagName;

            // Allow the Backspace key to work normally in text input fields
            if (tagName === 'INPUT' || tagName === 'TEXTAREA' || target.isContentEditable) {
                // If the input box is focused, let the event pass through normally
                return;
            } else {
                // Otherwise (if focused on the canvas/document body), prevent the default action
                // which often is navigating back a page in the browser
                event.preventDefault();
            }
        }
      }, true); 

      window.refreshLeaderboard = function() {
          renderScores();
      }

      // Initial Load
      renderScores();
    </script>
    {{{ SCRIPT }}}
  </body>
</html>