<!doctype html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Raylib Memory Game</title>
    <style>
        /* Leaderboard Styles */
        #leaderboard {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #00aeef;
            width: 200px;
            /* display: none; is removed here, we show it via JS when loaded */
        }
        #leaderboard h3 { margin: 0 0 10px 0; color: #00aeef; text-align: center; }
        #score-list { list-style: none; padding: 0; margin: 0; }
        #score-list li { 
            padding: 5px; 
            border-bottom: 1px solid #444; 
            display: flex; 
            justify-content: space-between;
            color: #fff; /* Ensure text is visible */
        }
        #score-list li:last-child { border-bottom: none; }
        .score-val { color: #ffd700; font-weight: bold; }

        body { 
            margin: 0; 
            padding: 0; 
            background-color: #222; 
            color: #fff;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
        }
        #canvas {
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            image-rendering: pixelated;
        }
        .spinner {
            height: 30px;
            width: 30px;
            margin: 0px auto;
            animation: rotation 0.6s linear infinite;
            border-left: 6px solid rgba(0, 174, 239, 0.15);
            border-right: 6px solid rgba(0, 174, 239, 0.15);
            border-bottom: 6px solid rgba(0, 174, 239, 0.15);
            border-top: 6px solid rgba(0, 174, 239, 0.8);
            border-radius: 100%;
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -15px;
            margin-left: -15px;
            z-index: 999;
        }
        @keyframes rotation {
            from {transform: rotate(0deg);}
            to {transform: rotate(359deg);}
        }
    </style>
  </head>
  <body>
    <div class="spinner" id='spinner'></div>
    
    <div id="leaderboard">
        <h3>Global Leaders</h3>
        <ul id="score-list">
            <li style="justify-content:center; color:#888;">Loading...</li>
        </ul>
    </div>

    <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" tabindex=-1></canvas>
    
    <script type='text/javascript'>
      var Module = {
        print: (function() {
          return function(text) {
            console.log(text);
          };
        })(),
        canvas: document.getElementById('canvas'),
        setStatus: function(text) {
          if (!text) return;
          console.log("Status: " + text);
        },
        onRuntimeInitialized: function() {
            // Hide spinner when loaded
            document.getElementById('spinner').style.display = 'none';
            // Focus canvas for input
            document.getElementById('canvas').focus();
        }
      };

      // --- DREAMLO CONFIGURATION ---
      // These keys look valid, but always confirm them on dreamlo.com
      const PRIVATE_KEY = "FmD-OFRIfUiqAQRcOJfgIwXF4CTJUP2kyktm0h6ad4eQ"; 
      const PUBLIC_KEY  = "692222898f40bb186436a661";  
      const BASE_URL = "https://www.dreamlo.com/lb/";

      // 1. Fetch Scores from the Cloud
      function renderScores() {
          const list = document.getElementById('score-list');
          if (!list) return;

          // '/json-asc' sorts for the lowest score being the best (ideal for moves/time)
          fetch(`${BASE_URL}${PUBLIC_KEY}/json-asc`)
              .then(response => response.json())
              .then(data => {
                  list.innerHTML = '';
                  if (!data.dreamlo.leaderboard) {
                      list.innerHTML = '<li style="color:#888;">No scores yet!</li>';
                      return;
                  }
                  let entries = data.dreamlo.leaderboard.entry;
                  if (!Array.isArray(entries)) { entries = [entries]; }
                  const topScores = entries.slice(0, 5);

                  topScores.forEach((entry, index) => {
                      const li = document.createElement('li');
                      li.innerHTML = `
                        <span>#${index + 1} ${entry.name.substring(0, 10)}</span> 
                        <span class="score-val">${entry.score}</span>
                      `;
                      list.appendChild(li);
                  });
              })
              .catch(err => {
                  console.error("Error fetching scores:", err);
                  list.innerHTML = '<li style="color:red;">Offline</li>';
              });
      }

      // --- New Function for C++ to call on start ---
      window.refreshLeaderboard = function() {
          renderScores();
      }

      // 2. Send Score to the Cloud (Called by C++)
      window.updateLeaderboard = function(score) {
          // Ask the player for their name using the browser's native popup
          let playerName = prompt("New Record! Enter your name (Max 10 chars):", "Guest");

          // Basic cleanup
          if (!playerName) playerName = "Guest";
          playerName = playerName.replace(/[^a-zA-Z0-9]/g, ""); 
          if (playerName.length > 10) playerName = playerName.substring(0, 10);

          // Send to Dreamlo: URL/Private/Add/Name/Score/Seconds
          const url = `${BASE_URL}${PRIVATE_KEY}/add/${playerName}/${score}/0`;

          fetch(url)
              .then(() => { 
                // After submitting, refresh the display
                renderScores(); 
              })
              .catch(err => console.error("Error sending score:", err));
      };

      // Load scores immediately on startup
      var lb = document.getElementById('leaderboard');
      if(lb) {
          lb.style.display = 'block';
          renderScores();
      }
    </script>
    {{{ SCRIPT }}}
  </body>
</html>